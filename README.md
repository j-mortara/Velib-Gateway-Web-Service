# Velib Gateway Web Service

#### An IWS exposing the JCDecaux API to access the Velib Web Service.

## Project Structure

This project consists of four parts :

- An **Intermediate Web Server** (IWS) (contained in the `Server` directory) exposing a WS-SOAP API to access the Velib Web Service provided by [**JCDecaux**](https://developer.jcdecaux.com/#/opendata/vls?page=getstarted).
- A **console application** (contained in the `ServerApp` directory) launching the IWS.
- A **console client** (contained in the `ConsoleClient` directory) connecting to the IWS to fetch information coming from the **JCDecaux** API
- A **GUI client** (contained in the `Client` directory), being the GUI version of the console client.

## Building the project

- Include your API key in the project (see the [next section](https://github.com/trinity357/Velib-Gateway-Web-Service#using-your-own-api-key) for detailed procedure).
- Run Visual Studio **in Administrator Mode**. Otherwise, you won't have access to the port where the service is hosted.
- Open the `VelibGateway.sln` solution file contained in the `Client` directory.
- Add the **Newtonsoft.Json** NuGet package to the `Server` project.
- Set the `Client` project as StartUp project.
- Run `ServerApp\bin\Debug\ServerApp.exe` **in Administrator Mode**. To exit the program, simply type `exit` and the server will close.
- Run the solution.

## Using your own API key

### Become a JCDecaux developer
In order to use the **JCDecaux** API, you need to have an API key delivered after subscription on [**their website**](https://developer.jcdecaux.com/#/signup).

### Include the key in the project
You then need to create an `api_key.txt` file in the `Server` directory containing only your key. The server will fetch the content of the file as a resource :

```cs
private static string API_KEY = Server.Properties.Resources.api_key;
```

## Extensions

### Available extensions

#### Development

- [X] **GUI client**
- [X] **Asynchronous accesses to WS**
- [X] **Added cache to IWS**


#### Deployment

- [ ] Deployment on Docker


#### Monitoring

- [ ] Second WS to monitor fetch and compute information from the WS

### Extensions descriptions

- #### Concerning the asynchronous calls

Instead of directly calling the synchronous methods we implemented, we call the corresponding asynchronous methods generated by Visual Studio. This allows to make asynchronous calls to the IWS in a simple manner. However, this implies some changes in the code.

##### Example of synchronous to asynchronous transformation for the `getContracts()` method.

```cs
// IVelibInfos.cs
[OperationContract]
List<string> GetContracts();

// VelibInfos.cs
public List<string> GetContracts()
{
    var contracts = GetArray("https://api.jcdecaux.com/vls/v1/contracts?apiKey=" + API_KEY)
        .Children()
        .Select(child => (string)child["name"])
        .ToList();
    contracts.Sort();
    return contracts;
}

// MainWindow.xaml.cs
listBoxContracts.ItemsSource = velibInfos.GetContracts();
```

becomes :

```cs
// IVelibInfos.cs
[OperationContract]
Task<List<string>> GetContracts();

// VelibInfos.cs
public async Task<List<string>> GetContracts()
{
    var contracts = (await GetArray("https://api.jcdecaux.com/vls/v1/contracts?apiKey=" + API_KEY))
        .Children()
        .Select(child => (string)child["name"])
        .ToList();
    contracts.Sort();
    return contracts;
}

// MainWindow.xaml.cs
listBoxContracts.ItemsSource = await velibInfos.GetContractsAsync();
```

- #### Concerning the caching extension :

The `Station` object has a method `isInformationOutdated()` which returns a `bool` indicating if the cached value is too old to be reliable.  
For debugging purpose, this value has been set to 5 seconds but can be easily modified, as it is a field of the `Station` class.

```cs
// Number of seconds representing the timelapse we consider data as being up-to-date
private static readonly int dataUpToDateTimelapse = 5;
```

At runtime, when a station is selected, a message is logged in the console to show the cache behaviour :

- `Station never queried, adding to cache.` : This is the first time we query information about this station. A new `Station` object is added to the cache.
- `Outdated information, updating information.` : Information about this station is already present in the cache, but it needs to be updated. A new `Station` object replacing the old one is added to the cache.
- `Getting value from cache.` : Information about this station is already present in the cache and is considered as up-to-date. We directly get the value from the cache.
